import os
import cv2
import numpy as np
from pathlib import Path

def create_yolo_annotations(img_folder, mask_folder, ann_folder):
    """
    Create YOLO annotation files from image-mask pairs
    
    Args:
        img_folder: Path to folder containing original images
        mask_folder: Path to folder containing mask images (with transparency)
        ann_folder: Path to folder where annotation files will be saved
    """
    
    # Create annotation folder if it doesn't exist
    Path(ann_folder).mkdir(exist_ok=True)
    
    # Get all image files from img folder
    img_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff']
    image_files = []
    
    for ext in img_extensions:
        image_files.extend(Path(img_folder).glob(f'*{ext}'))
        image_files.extend(Path(img_folder).glob(f'*{ext.upper()}'))
    
    print(f"Found {len(image_files)} images to process...")
    
    for img_path in image_files:

        mask_path = find_matching_mask(img_path, mask_folder)
        
        if mask_path is None:
            print(f"Warning: No matching mask found for {img_path.name}")
            continue
            
        try:
            # Process the image-mask pair
            annotation_content = process_image_mask_pair(img_path, mask_path)
            
            # Save annotation file
            ann_filename = img_path.stem + '.txt'
            ann_filepath = Path(ann_folder) / ann_filename
            
            with open(ann_filepath, 'w') as f:
                f.write(annotation_content)
                
            print(f"Created annotation: {ann_filename}")
            
        except Exception as e:
            print(f"Error processing {img_path.name}: {str(e)}")

def find_matching_mask(img_path, mask_folder):
    """Find the mask file that matches the image filename"""

    img_stem = img_path.stem
    mask_extensions = ['.png', '.jpg', '.jpeg', '.bmp', '.tiff']
    
    for ext in mask_extensions:
        mask_path = Path(mask_folder) / f"{img_stem}{ext}"
        if mask_path.exists():
            return mask_path
        mask_path = Path(mask_folder) / f"{img_stem}{ext.upper()}"
        if mask_path.exists():
            return mask_path
    
    return None

def process_image_mask_pair(img_path, mask_path):
    """
    Process image and mask to create YOLO annotation
    Returns: String containing YOLO annotation
    """
    # Read the mask image with alpha channel
    mask_img = cv2.imread(str(mask_path), cv2.IMREAD_UNCHANGED)
    
    if mask_img is None:
        raise ValueError(f"Could not read mask image: {mask_path}")
    
    img_height, img_width = mask_img.shape[:2]
    
    if mask_img.shape[2] == 4:  # RGBA image
        # Use alpha channel as mask (transparent = background)
        binary_mask = mask_img[:, :, 3] > 128  # Threshold alpha channel
    else:
        # If no alpha channel, assume non-black pixels are the mask
        gray_mask = cv2.cvtColor(mask_img, cv2.COLOR_BGR2GRAY)
        binary_mask = gray_mask > 128
    
    binary_mask_uint8 = (binary_mask * 255).astype(np.uint8)
    contours, _ = cv2.findContours(binary_mask_uint8, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    
    if not contours:
        raise ValueError("No contours found in the mask")
    
    annotation_lines = []
    for contour in contours:
        # Skip very small contours
        if cv2.contourArea(contour) < 100:
            continue
            
        # Get bounding box
        x, y, w, h = cv2.boundingRect(contour)
        
        # Convert to YOLO format (normalized coordinates)
        x_center = (x + w / 2) / img_width
        y_center = (y + h / 2) / img_height
        width_norm = w / img_width
        height_norm = h / img_height
        
        # Get segmentation points
        epsilon = 0.0008 * cv2.arcLength(contour, True)
        approx_contour = cv2.approxPolyDP(contour, epsilon, True)
        
        # Normalize segmentation points
        segmentation_points = []
        for point in approx_contour:
            x_norm = point[0][0] / img_width
            y_norm = point[0][1] / img_height
            segmentation_points.extend([x_norm, y_norm])
        
        # Format: class_id bbox_x_center bbox_y_center bbox_width bbox_height seg_point1_x seg_point1_y ...
        line = f"0 {x_center:.6f} {y_center:.6f} {width_norm:.6f} {height_norm:.6f}"
        
        # Add segmentation points
        for point in segmentation_points:
            line += f" {point:.6f}"
        
        annotation_lines.append(line)
    
    return "\n".join(annotation_lines)

def main():
    # Define folder paths (relative to script location)
    script_dir = Path(__file__).parent
    img_folder = script_dir / "img"
    mask_folder = script_dir / "mask"
    ann_folder = script_dir / "ann"
    
    # Create annotations
    create_yolo_annotations(img_folder, mask_folder, ann_folder)
    print("Annotation generation completed!")

if __name__ == "__main__":
    main()
